# 服务编排

随着微服务的普及，应用之间的通信有了足够多的成熟方案。Dubbo 在 2011 年开源之后，被大量的中小型公司采用；在 Spring Boot 推出之后，Spring 逐渐焕发出第二春，随即 Spring Cloud 面世，逐渐占领市场，在中国市场中，和 Dubbo 分庭抗争；gRPC 是 Google 推出的基于 Http2 的端到端的通信工具，逐渐地在 Kubernetes 市场上占据统治地位，如 etcd，Istio 等都采用 gRPC 作为通信工具；Service Mesh 从开始概念上就火热，现在逐渐走向成熟，Istio + Envoy（其他 sidecar）逐渐开始走上舞台。

从功能层面来说，对开发者有感知的功能有：服务实现，服务暴露（注解或配置），服务调用（注解或配置），服务治理等。从选型角度会关注以下几点：易用性（开发易用性和开箱即用）、性能、功能、扩展性等。

# 服务的定义

服务怎么定义呢？需要从应用开发者角度看待怎么定义服务。服务在功能维度对应某一功能，如查询已买订单详情。在 Dubbo 中，对应某个接口下的方法；在 Spring Cloud 和 gRPC 对应一个 http 请求。如果从面向函数编程角度，一个服务就是一个 function 。在 Java 语言中，class 是一切编程的基础，所以将某些服务按照一定的维度进行聚合，放到某个接口中，就成了一个接口包含了很多的服务。从 Dubbo 角度来解释下：Dubbo 是面向接口编程的远程通信，所以 Dubbo 是面向服务集的编程，你如果想调用某个服务，必须通过接口的方式引入，然后调用接口中的某个服务。Dubbo Ops 中提供的服务查询功能，其实不是查询单个服务，而是通过查询接口（服务集）之后获得具体的方法（服务）。

而在 Spring Cloud 的世界里，服务提供方会将自己的应用信息（IP + port）注册成应用下的一个实例，服务消费方和服务提供方按照约定的形式进行 Rest 请求。每个请求对应的也是一个服务。Kubernetes 里的 Service 其实是对应到一组 Pod + port 列表，和 DNS 联系紧密；用通俗易懂的方式表达：维护了 Pod 集合的关系映射。和上面讲的服务是属于不同场景下的两个概念。

一个应用下包含了很多接口，一个接口下包含了很多服务（Dubbo）；或者一个应用包含了很多的服务（Spring Cloud）。按照这个方式定义服务，服务治理的粒度其实也是按照服务粒度，可以针对每个服务设置超时时间，设置路由规则等等。

## 接口维度的注册

- 优点：服务查询按照接口维度查询非常方便，实现难度低。应用拆分或者合并的时候，Client 端（消费者）无需关心，做到了让用户无感

- 缺点：和 Kubernetes 等主流平台的模型对应关系不匹配。注册的数据量非常大，有一定的性能风险

## 应用维度的注册

- 优点：和 Kubernetes，Spring Cloud 等模型对应关系一致，性能上可以得到很大缓解

- 缺点：应用拆分或者合并的时候，Client 端需要感知（如果想做到不感知,需要框架开发者维护一份接口和应用映射关系的存储）。如果想对用户保持 Dubbo 原有的接口维度的查询，需要较多的工作量来保证。对用户透明度有所减少，需要在 OPS 上提供其他一些工具。如供应用开发者可以查看具体某个 IP 是否提供了某个服务等等。
