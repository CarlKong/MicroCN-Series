# 爱奇艺微服务标准技术架构实践

在微服务化的过程中，各业务团队根据自身需要选择了不同的开源框架，如 Apache Dubbo/Spring Cloud 等，此外也存在一些自研性质的框架；另外为了满足对微服务应用的监控等需求，不少团队还自行维护了监控系统等基础设施。随着实践的深入，一些问题逐渐开始暴露，这其中包括：

- 部分基础设施存在重复建设，在资源浪费的同时稳定性也不易保证；
- 由于使用的技术架构和 SDK 不统一，最佳实践难以在团队间快速推广；
- 技术架构不统一导致在东西向流量中大量引入了业务自行维护的网关，使得链路加长，影响排障效率和响应延时。

为了解决以上问题，爱奇艺中间件团队充分听取了业务在微服务实践中的需求和问题，推出了爱奇艺的微服务标准架构。在标准架构的建设过程中，我们主要遵循了以下的一些原则：

- 架构统一：同一技术领域往往有多种技术实现，但是过多的技术框架的采用容易造成维护成本过高，缺乏专人支持等问题。在微服务标准架构的选型过程中，我们综合了各开源项目的实际情况和业界的主流技术方案，将各个领域中的技术选型进行了统一，每个领域的技术选型原则上均不超过 1 种。
- 可扩展：微服务标准架构中有不少开发 SDK 的选型，为了满足各个开发团队不同的业务需求，需要保证各个 SDK 的可扩展性，如果开源版本无法满足内部需求的，爱奇艺中间件团队都会维护统一化的内部定制版本。
- 高可用：标准架构的建设目的之一是将各个团队维护的基础设施（如注册中心、监控系统等）逐渐收拢至内部的公共平台。对相关平台的技术架构 review 及可用性维护也是我们的重要工作之一，此外我们还建设了服务成熟度体系 SMMI，会定期对核心系统及基础服务进行成熟度评估。
- 技术演进：开源软件均有其生命周期，需要充分考虑各个软件的社区维护情况，比如在熔断技术选型上，我们在标准架构中主推了 Sentinel，而不是目前已经停止维护的 Hystrix。另外标准架构也并非一个一成不变的体系，对于新技术的采纳，我们也提供了标准化的流程，确保我们的技术体系能持续迭代。
- 内部开源：在标准架构的建设过程中，在爱奇艺内部开展了内部开源的协作模式。除了基础服务部门以外，也鼓励业务团队参与到这些基础服务的维护工作中来，共同打造一个即符合业务需求，又有一定业界领先度的微服务技术体系，这样也进一步促进了相关标准架构的推广和完善。

## 标准架构

![爱奇艺标准架构](https://s3.ax1x.com/2020/12/22/rrjZzd.png)

标准架构主要包括如下主要内容：

- 统一的微服务开发 SDK：核心开发框架 Dubbo/Spring Cloud；熔断限流框架 Sentinel 等；
- 统一的微服务基础设施，包括：
  - 注册中心：Nacos/consul；
  - 服务网关：基于 kong 进行二次开发的网关平台，提供鉴权、限流等功能；
  - 配置中心：基于携程 Apollo 进行二次开发的平台
  - 指标监控：prometheus 集群托管服务；
  - 链路监控：全链路平台（基于 skywalking 进行定制开发）；
  - 混沌工程：在 ChaosBlade 基础上进行二次研发，提供各类故障演练功能。
- 统一的微服务平台：QDAS（QIYI Distributed Application Service，爱奇艺分布式应用服务），提供微服务应用生命周期管理、服务治理、服务市场等功能。

# 注册中心演进

注册中心在微服务应用中是最重要的基础设施之一，原先在爱奇艺内部，注册中心的选型并不统一，之前在线上运行的注册中心有 ZooKeeper、eureka、consul 等。事实上，ZooKeeper、eureka 等并不是当前业界中微服务注册中心的最佳选型，以 Zookeeper 为例，其主要缺点包括：

- 无法横向扩展；
- 作为一个一致性的系统，在网络分区会产生不可用。

在调研了业界的各个方案后，我们选用了 Nacos 作为我们下一代的微服务注册中心。右下角是 Nacos 的整体介绍图，选用 Nacos 的主要原因是：

- 高性能，可以横向扩展；
- 既适用于传统为服务架构，也能适用于云原生环境，包括支持与 Istio 控制面对接；
- 提供了 Nacos-Sync 组件，可与其他注册中心进行数据同步，也使注册中心的迁移变得简便。

# 监控体系建设

服务监控是所有业务团队都极为关注的主题。完整的微服务监控体系一般需要有以下 3 个方面组成：

- 指标监控：包括 QPS/响应延时/错误率等黄金指标、业务的自定义指标、JAVA 应用的 JVM 指标，此外还需要采集和基础环境的相关指标，包括 CPU/内存利用率等；
- 日志监控：如错误日志的数量；也可以利用 AI 技术，对日志的模式进行统计分析等；
- 链路监控：由于微服务调用关系的复杂性，调用链追踪也是非常必要的，它可以帮助业务人员更好地分析应用间的依赖关系，并能够监控各个调用关系上的核心指标。
